apiVersion: batch/v1
kind: Job
metadata:
  name: vae-preprocessing-job-a100
spec:
  template:
    metadata:
      labels:
        app: v2v-diffusion
        type: vae-preprocessing
        gpu: none
    spec:
      restartPolicy: Never

      containers:
      - name: vae-preprocessing
        image: kuntalkokate/llm_agent_v2v_train:latest
        imagePullPolicy: Always

        # Preprocessing-only command
        command: ["/bin/bash"]
        args:
        - "-c"
        - |
          echo "=========================================="
          echo "VAE Preprocessing Job (Full Reprocess)"
          echo "=========================================="
          echo "Node: $(hostname)"
          echo ""

          # Display storage status
          echo "Storage status:"
          df -h /workspace/storage_a100
          echo ""

          # Check dataset availability
          echo "Dataset directory:"
          ls -lh /workspace/storage_a100/dataset/
          echo ""

          # STEP 1: Clean existing cache (force full reprocess)
          echo "=========================================="
          echo "STEP 1: Cleaning existing cache..."
          echo "=========================================="
          CACHE_DIR="/workspace/storage_a100/.cache/slice_interpolation_cache"

          if [ -d "$CACHE_DIR/processed" ]; then
            echo "Removing existing processed cache..."
            du -sh "$CACHE_DIR/processed" 2>/dev/null || echo "Cache doesn't exist yet"
            rm -rf "$CACHE_DIR/processed"
            echo "✓ Processed cache cleared"
          else
            echo "No existing processed cache found"
          fi

          if [ -d "$CACHE_DIR/extracted" ]; then
            echo "Removing extraction cache..."
            rm -rf "$CACHE_DIR/extracted"
            echo "✓ Extraction cache cleared"
          fi

          echo ""

          # STEP 2: Run preprocessing via VAE training script (num_epochs=0)
          echo "=========================================="
          echo "STEP 2: Running preprocessing..."
          echo "=========================================="
          echo "This will process all 356 valid patients"
          echo "Expected time: ~30-60 minutes"
          echo ""

          # Set num_epochs to 0 in config to exit after preprocessing
          sed -i 's/num_epochs: 20/num_epochs: 0/' /workspace/config/vae_training.yaml

          # Run training script (will preprocess then exit)
          python /workspace/train_vae.py \
            --config /workspace/config/vae_training.yaml \
            2>&1 | tee /workspace/storage_a100/logs/preprocessing_$(date +%Y%m%d_%H%M%S).log

          # Restore original config
          sed -i 's/num_epochs: 0/num_epochs: 20/' /workspace/config/vae_training.yaml

          echo ""
          echo "=========================================="
          echo "STEP 3: Verification"
          echo "=========================================="

          # Count processed files
          PROCESSED_COUNT=$(ls -1 "$CACHE_DIR/processed/"*.pt 2>/dev/null | wc -l)
          echo "Preprocessed files created: $PROCESSED_COUNT"
          echo "Expected: 356 files (after excluding 19 corrupted cases)"
          echo ""

          # Show file range
          echo "First 10 files:"
          ls "$CACHE_DIR/processed/" | sort | head -10
          echo ""
          echo "Last 10 files:"
          ls "$CACHE_DIR/processed/" | sort | tail -10
          echo ""

          # Check for missing ranges
          echo "Checking for missing case ranges..."
          python3 << 'EOF'
import os
from pathlib import Path

cache_dir = Path("/workspace/storage_a100/.cache/slice_interpolation_cache/processed")
if cache_dir.exists():
    files = sorted(cache_dir.glob("case_*.pt"))
    case_numbers = [int(f.stem.split('_')[1]) for f in files]

    if case_numbers:
        print(f"Case range: {min(case_numbers)} to {max(case_numbers)}")
        print(f"Total cases: {len(case_numbers)}")

        # Check for gaps
        missing = []
        for i in range(min(case_numbers), max(case_numbers) + 1):
            if i not in case_numbers:
                missing.append(i)

        if missing:
            print(f"\nMissing case numbers: {missing[:50]}")  # Show first 50
            if len(missing) > 50:
                print(f"... and {len(missing) - 50} more")
        else:
            print("\n✓ No gaps in case numbering")
    else:
        print("No case files found!")
else:
    print("Processed directory doesn't exist!")
EOF

          echo ""

          # Check cache size
          if [ -d "$CACHE_DIR/processed" ]; then
            echo "Cache size:"
            du -sh "$CACHE_DIR/processed"
            echo "Expected: ~100-120 GB for 356 patients"
          fi

          echo ""

          # Check for failures
          if [ -f "$CACHE_DIR/preprocessing_failures.txt" ]; then
            echo "Preprocessing failures report:"
            cat "$CACHE_DIR/preprocessing_failures.txt"
          fi

          echo ""
          echo "=========================================="
          echo "Preprocessing completed!"
          echo "=========================================="

          # Exit status
          if [ "$PROCESSED_COUNT" -ge 350 ]; then
            echo "✓ SUCCESS: Sufficient files preprocessed"
            exit 0
          else
            echo "✗ WARNING: Expected ~356 files, got $PROCESSED_COUNT"
            exit 1
          fi

        resources:
          requests:
            memory: "32Gi"  # More memory for preprocessing
            cpu: "16"       # More CPU cores for parallel DICOM reading
          limits:
            memory: "32Gi"
            cpu: "16"

        volumeMounts:
        - name: storage
          mountPath: /workspace/storage_a100

        env:
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: TORCH_HOME
          value: "/workspace/storage_a100/.cache/torch"
        - name: HF_HOME
          value: "/workspace/storage_a100/.cache/huggingface"

      volumes:
      - name: storage
        persistentVolumeClaim:
          claimName: v2v-diffuser-kuntal-a100
